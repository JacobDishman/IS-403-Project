<%- include('partials/header', {pageTitle: 'Calendar - Cal-Endure to the End'}) %>
<body class="app-page">
    <%- include('partials/app-navbar', {currentPage: 'calendar'}) %>

    <!-- Main Content -->
    <main class="app-main">
        <div class="app-container">
            <!-- Page Header -->
            <header class="page-header">
                <div>
                    <h1 class="page-title">Calendar</h1>
                    <p class="page-subtitle">Plan every hour of your day</p>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="goToToday()">Today</button>
                    <button class="btn-primary" onclick="openAddEventModal()">
                        <span>+ Add Event</span>
                    </button>
                </div>
            </header>

            <!-- Calendar Controls -->
            <div class="calendar-controls">
                <div class="calendar-nav">
                    <button class="btn-icon" onclick="previousMonth()">‚óÄ</button>
                    <h2 id="current-month">February 2025</h2>
                    <button class="btn-icon" onclick="nextMonth()">‚ñ∂</button>
                </div>
                <div class="calendar-view-toggle">
                    <button class="view-btn active" data-view="month">Month</button>
                    <!-- Week and Day views coming soon -->
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-container">
                <div class="calendar-weekdays">
                    <div class="weekday">Sunday</div>
                    <div class="weekday">Monday</div>
                    <div class="weekday">Tuesday</div>
                    <div class="weekday">Wednesday</div>
                    <div class="weekday">Thursday</div>
                    <div class="weekday">Friday</div>
                    <div class="weekday">Saturday</div>
                </div>
                <div class="calendar-days" id="calendar-days">
                    <!-- Days will be generated by JavaScript -->
                </div>
            </div>

            <!-- Today's Schedule -->
            <div class="todays-schedule">
                <h3>Today's Schedule</h3>
                <div class="schedule-list" id="todays-events">
                    <% if (typeof todayEvents !== 'undefined' && todayEvents.length > 0) { %>
                        <% todayEvents.forEach(function(event) { %>
                            <div class="schedule-event <%= event.event_type ? event.event_type.toLowerCase() : 'spiritual' %>" draggable="true" ondragstart="dragEvent(event)" data-event-id="<%= event.event_id %>">
                                <div class="event-time-badge"><%= event.start_time ? event.start_time.substring(0, 5) : '' %></div>
                                <div class="event-details">
                                    <div class="event-title"><%= event.title %></div>
                                    <div class="event-meta">
                                        <span class="event-type">
                                            <% if (event.event_type === 'Spiritual') { %>‚úùÔ∏è
                                            <% } else if (event.event_type === 'Social') { %>üë•
                                            <% } else if (event.event_type === 'Intellectual') { %>üìö
                                            <% } else if (event.event_type === 'Physical') { %>üí™
                                            <% } else if (event.event_type === 'Romantic') { %>‚ù§Ô∏è
                                            <% } %> <%= event.event_type %>
                                        </span>
                                        <% if (event.contacts && event.contacts.length > 0) { %>
                                            <span class="event-contact"><%= event.contacts[0].first_name %> <%= event.contacts[0].last_name %></span>
                                        <% } else { %>
                                            <span class="event-contact">Personal</span>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="event-actions">
                                    <form action="/calendar/delete/<%= event.event_id %>" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this event?')">
                                        <button type="submit" class="btn-icon-small">üóëÔ∏è</button>
                                    </form>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="schedule-event" style="justify-content: center;">
                            <p style="color: #697268; font-style: italic;">No events scheduled for today. Click + Add Event to create one!</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Event Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="event-modal-title">Add New Event</h2>
                <button class="modal-close" onclick="closeEventModal()">&times;</button>
            </div>
            <form id="event-form" class="modal-form" action="/calendar/create" method="POST">
                <div class="form-row">
                    <div class="form-group">
                        <label for="event-title">Event Title</label>
                        <input type="text" id="event-title" name="title" placeholder="What's happening?" required>
                    </div>
                    <div class="form-group">
                        <label for="event-type">Event Type</label>
                        <select id="event-type" name="eventType" required>
                            <option value="">Select type...</option>
                            <option value="Spiritual">‚úùÔ∏è Spiritual</option>
                            <option value="Social">üë• Social</option>
                            <option value="Intellectual">üìö Intellectual</option>
                            <option value="Physical">üí™ Physical</option>
                            <option value="Romantic">‚ù§Ô∏è Romantic</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="event-date">Date</label>
                        <input type="date" id="event-date" name="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="event-start-time">Start Time</label>
                        <input type="time" id="event-start-time" name="startTime" required>
                    </div>
                    <div class="form-group">
                        <label for="event-end-time">End Time</label>
                        <input type="time" id="event-end-time" name="endTime">
                    </div>
                </div>

                <div class="form-group">
                    <label for="event-location">Location (Optional)</label>
                    <input type="text" id="event-location" name="location" placeholder="Where is this happening?">
                </div>

                <div class="form-group">
                    <label for="event-contacts">Attach Contacts</label>
                    <select id="event-contacts" name="contacts" multiple class="multi-select">
                        <% if (typeof contacts !== 'undefined' && contacts.length > 0) { %>
                            <% contacts.forEach(function(contact) { %>
                                <option value="<%= contact.contact_id %>"><%= contact.first_name %> <%= contact.last_name %></option>
                            <% }); %>
                        <% } else { %>
                            <option value="">No contacts available</option>
                        <% } %>
                    </select>
                    <small class="form-hint">Hold Ctrl/Cmd to select multiple contacts</small>
                </div>

                <div class="form-group">
                    <label for="event-notes">Notes (Optional)</label>
                    <textarea id="event-notes" name="notes" rows="3" placeholder="Add any additional details..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-outline" onclick="closeEventModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Calendar state
        let currentDate = new Date();
        let selectedDate = new Date();

        // Generate calendar
        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayDiv = createDayCell(day, 'other-month');
                calendarDays.appendChild(dayDiv);
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === new Date().getDate() &&
                               month === new Date().getMonth() &&
                               year === new Date().getFullYear();
                const dayDiv = createDayCell(day, isToday ? 'today' : 'current-month');
                calendarDays.appendChild(dayDiv);
            }

            // Next month days
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells; // 6 rows √ó 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createDayCell(day, 'other-month');
                calendarDays.appendChild(dayDiv);
            }
        }

        function createDayCell(day, className) {
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${className}`;
            dayDiv.innerHTML = `
                <div class="day-number">${day}</div>
                <div class="day-events" ondrop="dropEvent(event)" ondragover="allowDrop(event)">
                    ${className === 'today' ? getSampleEvents() : ''}
                </div>
            `;
            dayDiv.addEventListener('click', () => showDayEvents(day));
            return dayDiv;
        }

        function getSampleEvents() {
            return `
                <div class="mini-event spiritual">Scripture Study</div>
                <div class="mini-event social">Lunch</div>
                <div class="mini-event physical">Workout</div>
            `;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            generateCalendar();
        }

        function showDayEvents(day) {
            console.log('Show events for day:', day);
            // In real implementation, filter and display events for this day
        }

        // Drag and drop
        let draggedEventId = null;

        function dragEvent(e) {
            draggedEventId = e.target.dataset.eventId;
            e.target.style.opacity = '0.5';
        }

        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = 'rgba(46, 192, 249, 0.1)';
        }

        function dropEvent(e) {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '';
            if (draggedEventId) {
                console.log('Moving event', draggedEventId, 'to', e.currentTarget.closest('.calendar-day'));
                // In real implementation, update event date in database
                draggedEventId = null;
            }
        }

        document.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('schedule-event')) {
                e.target.style.opacity = '1';
            }
        });

        document.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('day-events')) {
                e.target.style.backgroundColor = '';
            }
        });

        // Event modal functions
        function openAddEventModal() {
            document.getElementById('event-modal').style.display = 'flex';
            document.getElementById('event-modal-title').textContent = 'Add New Event';
            document.getElementById('event-form').reset();
            // Set today as default date
            document.getElementById('event-date').valueAsDate = new Date();
        }

        function closeEventModal() {
            document.getElementById('event-modal').style.display = 'none';
        }

        function editEvent(eventId) {
            openAddEventModal();
            document.getElementById('event-modal-title').textContent = 'Edit Event';
            // In real implementation, load event data
            console.log('Editing event:', eventId);
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                console.log('Deleting event:', eventId);
                // In real implementation, delete from database and remove from DOM
            }
        }

        // Form submission - let it submit normally to server
        // No need to prevent default

        // View toggle
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const view = this.dataset.view;
                console.log('Switching to view:', view);
                // In real implementation, change calendar view
            });
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('event-modal');
            if (event.target === modal) {
                closeEventModal();
            }
        }

        // User dropdown toggle
        document.querySelector('.user-menu').addEventListener('click', function(e) {
            this.querySelector('.user-dropdown').classList.toggle('show');
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.querySelectorAll('.user-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Initialize calendar on page load
        generateCalendar();
    </script>
</body>
</html>
